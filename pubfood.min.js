/*! Pubfood v1.0.0 - Copyright (c) 2015 Pubfood (http://pubfood.org) */
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,e.pubfood=t()}}(function(){return function t(e,i,r){function o(s,a){if(!i[s]){if(!e[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(n)return n(s,!0);var p=new Error("Cannot find module '"+s+"'");throw p.code="MODULE_NOT_FOUND",p}var h=i[s]={exports:{}};e[s][0].call(h.exports,function(t){var i=e[s][1][t];return o(i?i:t)},h,h.exports,t,e,i,r)}return i[s].exports}for(var n="function"==typeof require&&require,s=0;s<r.length;s++)o(r[s]);return o}({1:[function(t,e,i){"use strict";function r(t,e,i){this.fn=t,this.context=e,this.once=i||!1}function o(){}var n=Object.prototype.hasOwnProperty,s="function"!=typeof Object.create&&"~";o.prototype._events=void 0,o.prototype.eventNames=function(){var t,e=this._events,i=[];if(!e)return i;for(t in e)n.call(e,t)&&i.push(s?t.slice(1):t);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},o.prototype.listeners=function(t,e){var i=s?s+t:t,r=this._events&&this._events[i];if(e)return!!r;if(!r)return[];if(r.fn)return[r.fn];for(var o=0,n=r.length,a=new Array(n);o<n;o++)a[o]=r[o].fn;return a},o.prototype.emit=function(t,e,i,r,o,n){var a=s?s+t:t;if(!this._events||!this._events[a])return!1;var u,p,h=this._events[a],d=arguments.length;if("function"==typeof h.fn){switch(h.once&&this.removeListener(t,h.fn,void 0,!0),d){case 1:return h.fn.call(h.context),!0;case 2:return h.fn.call(h.context,e),!0;case 3:return h.fn.call(h.context,e,i),!0;case 4:return h.fn.call(h.context,e,i,r),!0;case 5:return h.fn.call(h.context,e,i,r,o),!0;case 6:return h.fn.call(h.context,e,i,r,o,n),!0}for(p=1,u=new Array(d-1);p<d;p++)u[p-1]=arguments[p];h.fn.apply(h.context,u)}else{var c,l=h.length;for(p=0;p<l;p++)switch(h[p].once&&this.removeListener(t,h[p].fn,void 0,!0),d){case 1:h[p].fn.call(h[p].context);break;case 2:h[p].fn.call(h[p].context,e);break;case 3:h[p].fn.call(h[p].context,e,i);break;default:if(!u)for(c=1,u=new Array(d-1);c<d;c++)u[c-1]=arguments[c];h[p].fn.apply(h[p].context,u)}}return!0},o.prototype.on=function(t,e,i){var o=new r(e,i||this),n=s?s+t:t;return this._events||(this._events=s?{}:Object.create(null)),this._events[n]?this._events[n].fn?this._events[n]=[this._events[n],o]:this._events[n].push(o):this._events[n]=o,this},o.prototype.once=function(t,e,i){var o=new r(e,i||this,(!0)),n=s?s+t:t;return this._events||(this._events=s?{}:Object.create(null)),this._events[n]?this._events[n].fn?this._events[n]=[this._events[n],o]:this._events[n].push(o):this._events[n]=o,this},o.prototype.removeListener=function(t,e,i,r){var o=s?s+t:t;if(!this._events||!this._events[o])return this;var n=this._events[o],a=[];if(e)if(n.fn)(n.fn!==e||r&&!n.once||i&&n.context!==i)&&a.push(n);else for(var u=0,p=n.length;u<p;u++)(n[u].fn!==e||r&&!n[u].once||i&&n[u].context!==i)&&a.push(n[u]);return a.length?this._events[o]=1===a.length?a[0]:a:delete this._events[o],this},o.prototype.removeAllListeners=function(t){return this._events?(t?delete this._events[s?s+t:t]:this._events=s?{}:Object.create(null),this):this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prototype.setMaxListeners=function(){return this},o.prefixed=s,"undefined"!=typeof e&&(e.exports=o)},{}],2:[function(t,e,i){"use strict";function r(){this.operators=[]}r.prototype.addOperator=function(t){this.operators.push(t)},r.prototype.process=function(t,e){for(var i=t,r=0;r<this.operators.length;r++)i=this.operators[r].process(i,e);return i},e.exports=r},{}],3:[function(t,e,i){"use strict";function r(){this.operators=[]}r.prototype.addOperator=function(t){this.operators.push(t)},r.prototype.process=function(t,e){for(var i=t,r=0;r<this.operators.length;r++)i=this.operators[r].process(i,e);return i},e.exports=r},{}],4:[function(t,e,i){"use strict";function r(t){this.name="OP-"+o.newId(),this.transform=t}var o=t("../util"),n=t("../event"),s=t("../errors");r.validate=function(t){return!!t&&"function"===o.asType(t)},r.withDelegate=function(t){if(!r.validate(t))return null;var e=new r(t);return e},r.prototype.setName=function(t){return this.name=t,this},r.prototype.process=function(t,e){if(!t)return null;var i=this.transform(t,e);return i||n.publish(n.EVENT_TYPE.ERROR,new s("no transform output")),i||null},e.exports=r},{"../errors":5,"../event":6,"../util":17}],5:[function(t,e,i){"use strict";function r(t){this.name=o,this.message=t||"Pubfood integration error.",this.stack=(new Error).stack}var o="PubfoodError";r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,r.prototype.name=o,r.prototype.is=function(t){return t&&t.name===o},e.exports=r},{}],6:[function(t,e,i){"use strict";function r(){this.auctionId="pubfood:"+Date.now(),this.observeImmediate_={}}var o=t("./util"),n=t("./logger"),s=t("eventemitter3");r.prototype.setAuctionId=function(t){var e=o.asType(t);return"string"!==e&&"number"!==e||(this.auctionId=t),this.auctionId},r.prototype.EVENT_TYPE={PUBFOOD_API_LOAD:"PUBFOOD_API_LOAD",PUBFOOD_API_START:"PUBFOOD_API_START",PUBFOOD_API_REFRESH:"PUBFOOD_API_REFRESH",BID_LIB_START:"BID_LIB_START",BID_LIB_LOAD:"BID_LIB_LOAD",BID_LIB_LOADED:"BID_LIB_LOADED",BID_START:"BID_START",BID_PUSH_NEXT:"BID_PUSH_NEXT",BID_PUSH_NEXT_LATE:"BID_PUSH_NEXT_LATE",BID_COMPLETE:"BID_COMPLETE",BID_ASSEMBLER:"BID_ASSEMBLER",AUCTION_LIB_START:"AUCTION_LIB_START",AUCTION_LIB_LOAD:"AUCTION_LIB_LOAD",AUCTION_LIB_LOADED:"AUCTION_LIB_LOADED",AUCTION_GO:"AUCTION_GO",AUCTION_START:"AUCTION_START",AUCTION_TRIGGER:"AUCTION_TRIGGER",AUCTION_REFRESH:"AUCTION_REFRESH",AUCTION_COMPLETE:"AUCTION_COMPLETE",AUCTION_POST_RUN:"AUCTION_POST_RUN",ERROR:"ERROR",WARN:"WARN",INVALID:"INVALID"},r.prototype.publish=function(t,e,i){var r=+new Date;t===this.EVENT_TYPE.PUBFOOD_API_START&&e&&(r=e);var o={auctionId:this.auctionId,ts:r,type:t,annotations:i||{},data:e||""};return n.logEvent(t,this.auctionId,o),this.emit(t,o)},o.extendsObject(r,s),r.prototype.emit=function(t){var e=s.prototype.emit.apply(this,arguments);return e&&this.EVENT_TYPE.AUCTION_POST_RUN!==t||(e=!0,this.observeImmediate_[t]=this.observeImmediate_[t]||[],this.observeImmediate_[t].push(Array.prototype.slice.call(arguments,1))),e},r.prototype.on=function(t,e){var i=this.observeImmediate_[t]||null;if(i){for(var r=0;r<i.length;r++)e.apply(this,i[r]);return this}return s.prototype.on.apply(this,arguments)},r.prototype.removeAllListeners=function(){return s.prototype.removeAllListeners.call(this),this.observeImmediate_={},this},r.prototype.ANNOTATION_TYPE={FORCED_DONE:{NAME:"forcedDone",ERROR:"error",TIMEOUT:"timeout"},AUCTION_TYPE:{NAME:"auctionType",INIT:"init",REFRESH:"refresh"}},r.prototype.newEventAnnotation=function(t,e,i,r){var o=r||{};return o[t||"undefined"]={type:e||"undefined",message:i||""},o},e.exports=new r},{"./logger":8,"./util":17,eventemitter3:1}],7:[function(t,e,i){"use strict";var r={name:"",libUri:"",timeout:0,init:function(t,e){},refresh:function(t,e){}};r.optional={refresh:!0,timeout:!0};var o={name:"__default__",libUri:" ",timeout:0,init:function(t,e,i){i()},refresh:function(t,e,i){i()}};o.optional={libUri:!0,refresh:!0,timeout:!0};var n=function(t,e){},s={slot:"",value:"",sizes:[],targeting:{},label:""},a={name:"",elementId:"",sizes:[],bidProviders:[]};e.exports={BidDelegate:o,AuctionDelegate:r,SlotConfig:a,BidObject:s,TransformDelegate:n}},{}],8:[function(t,e,i){"use strict";var r={history:[],dumpLog:function(t){if(console&&console.log){var e;t&&(e=new RegExp(t,"g"));for(var i=0;i<this.history.length;i++){var r=this.history[i];e?(e.lastIndex=0,r.eventName&&e.test(r.eventName)&&console.log(r),r.functionName&&e.test(r.functionName)&&console.log(r)):console.log(r)}}},logCall:function(t,e,i){this.history.push({ts:+new Date,auctionId:e,functionName:t,args:Array.prototype.slice.call(i)})},logEvent:function(t,e,i){this.history.push({ts:+new Date,auctionId:e,eventName:t,event:i})}};e.exports=r},{}],9:[function(t,e,i){"use strict";function r(t){this.init_&&this.init_(),this.prefix=!t||!t.hasOwnProperty("prefix")||t.prefix,this.slotMap={},this.bidProviders={},this.auctionProvider=null,this.auctionRun={},this.timeout_=r.NO_TIMEOUT,this.trigger_=null,this.bidAssembler=new a,this.requestAssembler=new u,this.auctionIdx_=0,this.doneCallbackOffset_=r.DEFAULT_DONE_CALLBACK_OFFSET,this.omitDefaultBidKey_=!1,this.throwErrors_=!1,c.setAuctionId(this.getAuctionId())}var o=t("../util"),n=t("../model/slot"),s=t("../model/bid"),a=t("../assembler/bidassembler"),u=t("../assembler/requestassembler"),p=t("../assembler/transformoperator"),h=t("../provider/auctionprovider"),d=t("../provider/bidprovider"),c=t("../event"),l=t("../pubfoodobject");r.PAGE_BIDS="page",r.AUCTION_TYPE={START:c.ANNOTATION_TYPE.AUCTION_TYPE.INIT,REFRESH:c.ANNOTATION_TYPE.AUCTION_TYPE.REFRESH},r.IN_AUCTION={FALSE:!1,PENDING:"pending",DONE:"done"},r.NO_TIMEOUT=-1,r.DEFAULT_DONE_CALLBACK_OFFSET=5e3,r.prototype.validate=function(t){var e=!0,i={hasAuctionProvider:function(){return!!this.auctionProvider},hasBidProviders:function(){var t=!1;for(var e in this.bidProviders){t=!0;break}return t||c.publish(c.EVENT_TYPE.WARN,{msg:"Warn: no bid providers"}),t},hasSlots:function(){for(var t in this.slotMap)return!0;return!1},hasAllSlotsBidder:function(){var t=[];for(var e in this.slotMap){var i=this.slotMap[e];i.bidProviders&&i.bidProviders[0]||t.push(i.name)}return t.length>0&&c.publish(c.EVENT_TYPE.WARN,{msg:"Warn: no bidders - "+t.join(", ")}),0===t.length}};i.hasBidProviders.warn=!0;for(var r in i)if(e=i[r].call(this),e=!!i[r].warn||e,!e){c.publish(c.EVENT_TYPE.INVALID,{msg:"Failed: "+r});break}return e},r.prototype.newAuctionRun=function(t,e){var i=++this.auctionIdx_,n=[];if(o.isArray(e)&&e.length>0)for(var s=0;s<e.length;s++){var a=e[s];this.slotMap[a]?n.push(this.slotMap[a]):c.publish(c.EVENT_TYPE.WARN,"Can't refresh slot \""+a+"\", because it wasn't defined")}else for(var u in this.slotMap)n.push(this.slotMap[u]);var p={timeoutId:0,inAuction:r.IN_AUCTION.FALSE,slots:n,bids:[],lateBids:[],bidStatus:{},targeting:[],auctionType:t||r.AUCTION_TYPE.START};for(var u in this.bidProviders){var h=this.bidProviders[u];!h||h.name in p.bidStatus||!h.enabled()||(p.bidStatus[h.name]=!1)}return this.auctionRun[i]=p,i},r.prototype.getBidStatus=function(t,e){var i=[];if(e){var r=this.auctionRun[e],n=r?r.bidStatus[t]:"";i="boolean"===o.asType(n)?n:-1}else for(var s in this.auctionRun){var n=this.auctionRun[s].bidStatus[t];i.push("boolean"===o.asType(n)?n:-1)}return i},r.prototype.timeout=function(t){this.timeout_="number"===o.asType(t)&&t>0?t:r.NO_TIMEOUT},r.prototype.getTimeout=function(){return this.timeout_},r.prototype.doneCallbackOffset=function(t){this.doneCallbackOffset_="number"===o.asType(t)?t:r.DEFAULT_DONE_CALLBACK_OFFSET},r.prototype.getDoneCallbackOffset=function(){return this.doneCallbackOffset_},r.prototype.setAuctionProviderCbTimeout=function(t){this.initDoneTimeout_="number"===o.asType(t)&&t>0?t:this.doneCallbackOffset_},r.prototype.setAuctionTrigger=function(t){this.trigger_=t},r.prototype.startAuction_=function(t,e,i){c.publish(c.EVENT_TYPE.BID_ASSEMBLER,"AuctionMediator"),this.bidAssembler.operators.length>0&&(this.auctionRun[t].bids=this.bidAssembler.process(this.auctionRun[t].bids)),this.processTargeting_(t,e,i)},r.prototype.startTimeout_=function(t,e){if(this.timeout_!==r.NO_TIMEOUT&&this.timeout_>=0){var i=t,n=e,s=o.bind(this.startAuction_,this);this.auctionRun[t].timeoutId=setTimeout(function(){s(i,n,!0)},this.timeout_)}return this},r.prototype.initAuctionTrigger_=function(t,e){function i(){this.auctionRun[r].inAuction||this.startAuction_(r,n)}if("function"!==o.asType(this.trigger_))return void this.startTimeout_(t,e);var r=t,n=e;return this.trigger_.apply(null,[o.bind(i,this)]),this},r.prototype.allBiddersDone=function(t){var e=!0,i=this.auctionRun[t].bidStatus;for(var r in i)if(!i[r]){e=!1;break}return e},r.prototype.checkBids_=function(t,e){this.allBiddersDone(t)&&!this.auctionRun[t].inAuction&&this.startAuction_(t,e)},r.prototype.getBidKey=function(t){return(this.prefix&&t.provider?t.provider+"_":"")+(t.label||"bid")},r.prototype.mergeKeys=function(t,e){t=o.mergeToObject(t,e)},r.prototype.getBidMap_=function(t){var e={};e[r.PAGE_BIDS]=[];for(var i=this.getAuctionRunBids(t),o=0;o<i.length;o++){var n=i[o];n.slot?(e[n.slot]=e[n.slot]||[],e[n.slot].push(n)):e[r.PAGE_BIDS].push(n)}return e},r.prototype.buildTargeting_=function(t){for(var e,i=[],o=this.getBidMap_(t),n=this.getAuctionRunSlots(t),s=0;s<n.length;s++){var a={bids:[],targeting:{}},u=n[s];a.name=u.name,a.id=u.id,a.elementId=u.elementId||"",a.sizes=u.sizes,a.type="slot",e=o[u.name]||[];for(var p=0;p<e.length;p++){var h=e[p];if(a.bids.push({value:h.value,provider:h.provider,id:h.id,targeting:h.targeting||{}}),!this.omitDefaultBidKey()){var d=this.getBidKey(h);a.targeting[d]=a.targeting[d]||h.value}this.mergeKeys(a.targeting,h.targeting)}i.push(a)}var c={bids:[],targeting:{}};e=o[r.PAGE_BIDS]||[];for(var l=0;l<e.length;l++){var h=e[l];if(c.bids.push({value:h.value,provider:h.provider,id:h.id,targeting:h.targeting}),!this.omitDefaultBidKey()){var d=this.getBidKey(h);c.targeting[d]=c.targeting[d]||h.value}this.mergeKeys(c.targeting,h.targeting)}return c.bids.length>0&&(c.type="page",i.push(c)),i},r.prototype.processTargeting_=function(t,e){if(!this.auctionRun[t].inAuction){this.auctionRun[t].inAuction=r.IN_AUCTION.PENDING;var i,o=this,n=!1,s=o.auctionProvider.name,a=t,u=o.auctionProvider.getTimeout(),p=this.auctionRun[t].timeoutId,h=function(t){var r={};c.newEventAnnotation(c.ANNOTATION_TYPE.AUCTION_TYPE.NAME,e,"Done auction type: "+e,r);for(var u in t)r[u]=t[u];n||(n=!0,clearTimeout(i),o.auctionDone(a,s,r))};i=setTimeout(function(){if(!n){p&&clearTimeout(p);var t='The auction done callback for "'+s+"\" hasn't been called within the allotted time ("+u/1e3+"sec)",e=c.newEventAnnotation(c.ANNOTATION_TYPE.FORCED_DONE.NAME,c.ANNOTATION_TYPE.FORCED_DONE.TIMEOUT,t);c.publish(c.EVENT_TYPE.WARN,"Warning:"+t),h(e)}},u),e===r.AUCTION_TYPE.START?(c.publish(c.EVENT_TYPE.AUCTION_GO,s),c.publish(c.EVENT_TYPE.AUCTION_START,s)):c.publish(c.EVENT_TYPE.AUCTION_REFRESH,s);var d=o.buildTargeting_(a);this.auctionRun[a].targeting=d;try{e===r.AUCTION_TYPE.START?o.auctionProvider.init(d,h):o.auctionProvider.refresh(d,h)}catch(l){c.publish(c.EVENT_TYPE.ERROR,l);var f=c.newEventAnnotation(c.ANNOTATION_TYPE.FORCED_DONE.NAME,c.ANNOTATION_TYPE.FORCED_DONE.ERROR,l.message);if(h(f),o.auctionProvider.throwErrors())throw l}}},r.prototype.auctionDone=function(t,e,i){this.auctionRun[t].inAuction=r.IN_AUCTION.DONE;var o=this.getAuctionRun(t).targeting;c.publish(c.EVENT_TYPE.AUCTION_COMPLETE,{name:e,targeting:o},i),setTimeout(function(){c.publish(c.EVENT_TYPE.AUCTION_POST_RUN,e)},0)},r.prototype.addSlot=function(t){var e=n.fromObject(t);return e?this.slotMap[e.name]=e:c.publish(c.EVENT_TYPE.WARN,"Invalid slot object: "+JSON.stringify(t||{})),e},r.prototype.getProviderDoneTimeout_=function(t){var e=this.timeout_+this.doneCallbackOffset_;return t.timeout&&(e=t.timeout),e},r.prototype.getBidProviderDoneTimeout_=function(t){var e=this.getProviderDoneTimeout_(t);return this.callbackTimeout_&&(e=this.callbackTimeout_),e},r.prototype.getAuctionProviderDoneTimeout_=function(t){var e=this.getProviderDoneTimeout_(t);return this.initDoneTimeout_&&(e=this.initDoneTimeout_),e},r.prototype.addBidProvider=function(t){var e=d.withDelegate(t);if(e)if(this.bidProviders[e.name])c.publish(c.EVENT_TYPE.WARN,"Warning: bid provider "+e.name+" is already added");else{var i=this.getBidProviderDoneTimeout_(t);e.timeout(i),e.throwErrors(this.throwErrors_),this.bidProviders[e.name]=e}else{var r=t&&t.name?t.name:"undefined";c.publish(c.EVENT_TYPE.WARN,"Warning: invalid bid provider: "+r)}return e},r.prototype.bidProviderExists_=function(t){return!!this.bidProviders[t]},r.prototype.setAuctionProvider=function(t){this.auctionProvider&&c.publish(c.EVENT_TYPE.WARN,"Warning: auction provider exists: "+this.auctionProvider.name);var e=h.withDelegate(t);if(e){var i=this.getAuctionProviderDoneTimeout_(t);e.timeout(i),e.throwErrors(this.throwErrors_),this.auctionProvider=e}else{var r=t&&t.name?t.name:"undefined";c.publish(c.EVENT_TYPE.WARN,"Warning: invalid auction provider: "+r)}return e},r.prototype.addRequestTransform=function(t){return this.requestAssembler.addOperator(new p(t)),this},r.prototype.addBidTransform=function(t){return this.bidAssembler.addOperator(new p(t)),this},r.prototype.loadProviders=function(t){var e,i=[];for(var r in this.bidProviders)i.push(r);t&&o.randomize(i);for(var n=0;n<i.length;n++){var s=i[n];if(this.bidProviders[s].libUri){c.publish(c.EVENT_TYPE.BID_LIB_LOAD,this.bidProviders[s].name),e=this.bidProviders[s].libUri()||"";var a=this.bidProviders[s].sync();o.loadUri(e,a)}}this.auctionProvider&&this.auctionProvider.libUri()&&(c.publish(c.EVENT_TYPE.AUCTION_LIB_LOAD,this.auctionProvider.name),e=this.auctionProvider.libUri(),o.loadUri(e))},r.prototype.getBidderSlots=function(t){var e,i,r={},o=[];for(e=0;e<t.length;e++){var n=t[e];for(i=0;i<n.bidProviders.length;i++){var s=n.bidProviders[i];r[s]=r[s]||[],r[s].push(n)}}for(i in this.bidProviders){var s=this.bidProviders[i];s&&s.enabled()&&o.push({provider:s,slots:r[i]||[]})}return o},r.prototype.start=function(t,e){if(!this.auctionProvider)return c.publish(c.EVENT_TYPE.WARN,"Warning: auction provider is not defined."),this;var i=this.newAuctionRun(r.AUCTION_TYPE.START);c.setAuctionId(this.getAuctionId(i)),c.publish(c.EVENT_TYPE.PUBFOOD_API_START,e),this.initAuctionTrigger_(i,r.AUCTION_TYPE.START),this.loadProviders(t);var o=this.getAuctionRunSlots(i),n=this.getBidderSlots(o);return this.processBids(i,r.AUCTION_TYPE.START,n),this},r.prototype.refresh=function(t){if(!this.auctionProvider)return c.publish(c.EVENT_TYPE.WARN,"Warning: auction provider is not defined."),this;var e=this.newAuctionRun(r.AUCTION_TYPE.REFRESH,t);c.setAuctionId(this.getAuctionId(e)),c.publish(c.EVENT_TYPE.PUBFOOD_API_REFRESH),this.initAuctionTrigger_(e,r.AUCTION_TYPE.REFRESH);var i=this.getAuctionRunSlots(e),o=this.getBidderSlots(i);return this.processBids(e,r.AUCTION_TYPE.REFRESH,o),this},r.prototype.processBids=function(t,e,i){for(var r=0;r<i.length;r++)this.getBids_(t,e,i[r].provider,i[r].slots)},r.prototype.setBidProviderCbTimeout=function(t){this.callbackTimeout_="number"===o.asType(t)&&t>0?t:this.doneCallbackOffset_},r.prototype.getBids_=function(t,e,i,o){var n,s=this,a=i.name,u=!1,p=t,h=i.getTimeout(),d=function(t){t.auctionIdx=p,s.pushBid(p,t,a)},l=function(t){var i={};c.newEventAnnotation(c.ANNOTATION_TYPE.AUCTION_TYPE.NAME,e,"Done auction type: "+e,i);for(var r in t)i[r]=t[r];u||(u=!0,clearTimeout(n),s.doneBid(p,e,a,i))};n=setTimeout(function(){if(!u){var t='The bid done callback for "'+a+"\" hasn't been called within the allotted time ("+h/1e3+"sec)";c.publish(c.EVENT_TYPE.WARN,"Warning: "+t);var e=c.newEventAnnotation(c.ANNOTATION_TYPE.FORCED_DONE.NAME,c.ANNOTATION_TYPE.FORCED_DONE.TIMEOUT,t);l(e)}},h),c.publish(c.EVENT_TYPE.BID_START,a);try{e===r.AUCTION_TYPE.START?i.init(o,d,l):i.refresh(o,d,l)}catch(f){c.publish(c.EVENT_TYPE.ERROR,f);var v=c.newEventAnnotation(c.ANNOTATION_TYPE.FORCED_DONE.NAME,c.ANNOTATION_TYPE.FORCED_DONE.ERROR,f.message);if(l(v),i.throwErrors())throw f}},r.prototype.pushBid=function(t,e,i){var r=s.fromObject(e);r?(r.provider=i,this.auctionRun[t].inAuction?(this.auctionRun[t].lateBids.push(r),c.publish(c.EVENT_TYPE.BID_PUSH_NEXT_LATE,r)):(this.auctionRun[t].bids.push(r),c.publish(c.EVENT_TYPE.BID_PUSH_NEXT,r))):c.publish(c.EVENT_TYPE.WARN,"Invalid bid object: "+JSON.stringify(e||{}))},r.prototype.doneBid=function(t,e,i,r){c.publish(c.EVENT_TYPE.BID_COMPLETE,i,r),this.auctionRun[t].bidStatus[i]=!0,this.checkBids_(t,e)},r.prototype.getAuctionCount=function(){return this.auctionIdx_},r.prototype.getAuctionId=function(t){var e=t||this.auctionIdx_;return this.id+":"+e},r.prototype.getAuctionRun=function(t){var e=this.auctionRun[t];return"undefined"===o.asType(e)?{}:e},r.prototype.getAuctionRunSlots=function(t){var e=this.auctionRun[t];return"undefined"===o.asType(e)?{}:e.slots},r.prototype.getAuctionRunBids=function(t){var e=this.auctionRun[t];return"undefined"===o.asType(e)?[]:e.bids},r.prototype.getAuctionRunLateBids=function(t){var e=this.auctionRun[t];return"undefined"===o.asType(e)?[]:e.lateBids},r.prototype.getAuctionRunTargeting=function(t){var e=this.auctionRun[t];return"undefined"===o.asType(e)?[]:e.targeting},r.prototype.getAuctionRunType=function(t){return this.auctionRun[t].auctionType},r.prototype.prefixDefaultBidKey=function(t){return"boolean"===o.asType(t)&&(this.prefix=t),this.prefix},r.prototype.omitDefaultBidKey=function(t){return"boolean"===o.asType(t)&&(this.omitDefaultBidKey_=t),this.omitDefaultBidKey_},r.prototype.throwErrors=function(t){if("boolean"===o.asType(t)){this.throwErrors_=t,this.throwErrors_=this.auctionProvider?this.auctionProvider.throwErrors(t):this.throwErrors_;for(var e in this.bidProviders){var i=this.bidProviders[e];this.throwErrors_=i?i.throwErrors(t):this.throwErrors_}}return this.throwErrors_},o.extendsObject(r,l),e.exports=r},{"../assembler/bidassembler":2,"../assembler/requestassembler":3,"../assembler/transformoperator":4,"../event":6,"../model/bid":10,"../model/slot":11,"../provider/auctionprovider":12,"../provider/bidprovider":13,"../pubfoodobject":16,"../util":17}],10:[function(t,e,i){"use strict";function r(t){this.init_&&this.init_(),this.sizes=[],this.slot,this.value="undefined"===o.asType(t)?"":t,this.type=o.asType(this.value),this.label,this.provider,this.targeting={}}var o=t("../util"),n=t("../pubfoodobject");r.fromObject=function(t){var e=new r,i=o.clone(t);for(var n in i)e[n]=i[n];var s=o.asType(e.value);return e.type="undefined"!==s?s:"",e},r.prototype.setValue=function(t){return this.value="undefined"===o.asType(t)?"":t,this.type=o.asType(this.value),this},r.prototype.addSize=function(t,e){var i=Math.abs(~~t),r=Math.abs(~~e);return this.sizes.push([i,r]),this},o.extendsObject(r,n),e.exports=r},{"../pubfoodobject":16,"../util":17}],11:[function(t,e,i){"use strict";function r(t,e){this.init_&&this.init_(),this.name=t,this.elementId=e,this.bidProviders=[],this.sizes=[]}var o=t("../util"),n=t("../pubfoodobject"),s=t("../interfaces").SlotConfig;r.validate=function(t){return!!t&&o.validate(s,t)},r.fromObject=function(t){if(!r.validate(t))return null;var e=new r;for(var i in t)e[i]=t[i];return e},r.prototype.addSizes=function(t){return Array.prototype.push.apply(this.sizes,t),this},r.prototype.addSize=function(t,e){var i=Math.abs(~~t),r=Math.abs(~~e);return this.sizes.push([i,r]),this},r.prototype.addBidProvider=function(t){return this.bidProviders.push(t),this},o.extendsObject(r,n),e.exports=r},{"../interfaces":7,"../pubfoodobject":16,"../util":17}],12:[function(t,e,i){"use strict";function r(t){this.init_&&this.init_();var e=t||{};this.name=e.name||"",this.auctionDelegate=e,this.timeout_=e&&e.timeout?e.timeout:0}var o=t("../util"),n=t("../interfaces").AuctionDelegate,s=t("../event"),a=t("./pubfoodprovider");r.withDelegate=function(t){if(!r.validate(t))return s.publish(s.EVENT_TYPE.INVALID,{msg:"Warn: invalid auction delegate - "+(t&&JSON.stringify(t))||""}),null;var e=new r(t);return e},r.validate=function(t){return o.validate(n,t)},r.prototype.libUri=function(){return this.auctionDelegate.libUri},r.prototype.init=function(t,e){this.auctionDelegate.init(t,e)},r.prototype.refresh=function(t,e){if(this.auctionDelegate&&this.auctionDelegate.refresh)this.auctionDelegate.refresh(t,e);else{var i="AuctionProvider.auctionDelegate.refresh not defined.";if(s.publish(s.EVENT_TYPE.WARN,i),"function"===o.asType(e)){var r=s.newEventAnnotation(s.ANNOTATION_TYPE.FORCED_DONE.NAME,s.ANNOTATION_TYPE.FORCED_DONE.ERROR,i);e(r)}}},r.prototype.timeout=function(t){this.timeout_="number"===o.asType(t)?t:0},r.prototype.getTimeout=function(){return this.timeout_},o.extendsObject(r,a),e.exports=r},{"../event":6,"../interfaces":7,"../util":17,"./pubfoodprovider":14}],13:[function(t,e,i){"use strict";function r(t){this.init_&&this.init_();var e=t||{};this.name=e.name||"",this.bidDelegate=e,this.enabled_=!0,this.timeout_=e&&e.timeout?e.timeout:0}var o=t("../util"),n=t("../interfaces").BidDelegate,s=t("../event"),a=t("./pubfoodprovider");r.withDelegate=function(t){if(!r.validate(t))return s.publish(s.EVENT_TYPE.WARN,{msg:"Warn: invalid bidder delegate - "+t||""}),null;var e=new r(t);return e},r.validate=function(t){return o.validate(n,t)},r.prototype.libUri=function(t){return t&&(this.bidDelegate.libUri=t),this.bidDelegate.libUri},r.prototype.sync=function(){var t=Array.prototype.slice.call(arguments);return t.length>0&&"boolean"===o.asType(t[0])&&(this.bidDelegate.sync=t[0]),!!this.bidDelegate.sync},r.prototype.init=function(t,e,i){this.bidDelegate.init(t,e,i)},r.prototype.refresh=function(t,e,i){var r=this.bidDelegate&&this.bidDelegate.refresh||null;if(r)r(t,e,i);else{var n="BidProvider.bidDelegate.refresh not defined.";if(s.publish(s.EVENT_TYPE.WARN,n),"function"===o.asType(i)){var a=s.newEventAnnotation(s.ANNOTATION_TYPE.FORCED_DONE.NAME,s.ANNOTATION_TYPE.FORCED_DONE.ERROR,n);i(a)}}},r.prototype.enabled=function(t){return"boolean"===o.asType(t)&&(this.enabled_=t),this.enabled_},r.prototype.timeout=function(t){this.timeout_="number"===o.asType(t)?t:0},r.prototype.getTimeout=function(){return this.timeout_},o.extendsObject(r,a),e.exports=r},{"../event":6,"../interfaces":7,"../util":17,"./pubfoodprovider":14}],14:[function(t,e,i){"use strict";function r(){this.throwErrors_=!1}var o=t("../pubfoodobject"),n=t("../util");r.prototype.throwErrors=function(t){return"boolean"===n.asType(t)&&(this.throwErrors_=t),this.throwErrors_},n.extendsObject(r,o),e.exports=r},{"../pubfoodobject":16,"../util":17}],15:[function(t,e,i){"use strict";var r=t("./event"),o=t("./util"),n=t("./logger"),s=t("./interfaces").BidDelegate,a=t("./mediator/auctionmediator");!function(t,i,r){t&&(e.exports=r(t,t.pfConfig||{}))}(window||{},void 0,function(e){if(e.pubfood)return e.pubfood.library.logger.logEvent(r.EVENT_TYPE.WARN,["multiple api load"]),e.pubfood;var i=function(t){return new i.library.init(t)};i.library=i.prototype={version:"1.0.0",PubfoodError:t("./errors"),logger:n};var u=function(t){var e=t.getBidProviders();for(var i in t.requiredApiCalls)0===t.requiredApiCalls[i]&&t.configErrors.push('"'+i+'" was not called');for(var r=t.getSlots(),o=0;o<r.length;o++)for(var n=0;n<r[o].bidProviders.length;n++){var s=r[o].bidProviders[n];e[s]||t.configErrors.push('No configuration found for bid provider "'+s+'"')}return{hasError:t.configErrors.length>0,details:t.configErrors}},p=i.library.init=function(t){return this.mediator=new a,t&&(this.randomizeBidRequests_=!!t.randomizeBidRequests,this.mediator.setBidProviderCbTimeout(t.bidProviderCbTimeout),this.mediator.setAuctionProviderCbTimeout(t.auctionProviderCbTimeout)),r.publish(r.EVENT_TYPE.PUBFOOD_API_LOAD),this.pushApiCall_("api.init",arguments),this.configErrors=[],this.requiredApiCalls={setAuctionProvider:0,addBidProvider:0},this.util=o,this};return p.prototype.pushApiCall_=function(t,e){this.library.logger.logCall(t,this.getAuctionId(),e)},p.prototype.getAuctionId=function(){return this.mediator.getAuctionId()},p.prototype.getAuctionCount=function(){return this.mediator.getAuctionCount()},p.prototype.getAuctionRun=function(t){return this.mediator.getAuctionRun(t)},p.prototype.dumpLog=function(t){this.library.logger.dumpLog(t)},p.prototype.addSlot=function(t){!o.isObject(t)||o.isArray(t.bidProviders)&&0!==t.bidProviders.length||(t.bidProviders=["__default__"],this.mediator.bidProviderExists_("__default__")||this.mediator.addBidProvider(s)),this.pushApiCall_("api.addSlot",arguments);var e=this.mediator.addSlot(t);return this.requiredApiCalls.addSlot++,e},p.prototype.getSlots=function(){this.pushApiCall_("api.getSlots",arguments);var t=[];for(var e in this.mediator.slotMap)t.push(this.mediator.slotMap[e]);return t},p.prototype.getSlot=function(t){return this.pushApiCall_("api.getSlot",arguments),this.mediator.slotMap[t]},p.prototype.setAuctionProvider=function(t){this.pushApiCall_("api.setAuctionProvider",arguments);var e=this.mediator.setAuctionProvider(t),i=t&&t.name?t.name:"undefined";return e?(this.requiredApiCalls.setAuctionProvider++,e):(this.configErrors.push("Invalid auction provider: "+i),null)},p.prototype.getAuctionProvider=function(){return this.pushApiCall_("api.getAuctionProvider",arguments),this.mediator.auctionProvider},p.prototype.addBidProvider=function(t){this.pushApiCall_("api.addBidProvider",arguments);var e=this.mediator.addBidProvider(t),i=t&&t.name?t.name:"undefined";return e?(this.requiredApiCalls.addBidProvider++,"function"===o.asType(t.init)&&3!==t.init.length&&this.configErrors.push("Bid provider "+i+"'s init method requires 3 arguments"),"function"===o.asType(t.refresh)&&3!==t.refresh.length&&this.configErrors.push("Bid provider "+i+"'s refresh method requires 3 arguments"),e):(this.configErrors.push("Invalid bid provider: "+i),null)},p.prototype.getBidProviders=function(){return this.pushApiCall_("api.getBidProviders",arguments),this.mediator.bidProviders},p.prototype.getBidProvider=function(t){return this.pushApiCall_("api.getBidProvider",arguments),this.mediator.bidProviders[t]},p.prototype.observe=function(t,e){if(this.pushApiCall_("api.observe",arguments),"function"==typeof t)for(var i in r.EVENT_TYPE)r.on(r.EVENT_TYPE[i],o.bind(t,this));else"string"==typeof t&&(r.EVENT_TYPE[t]?r.on(r.EVENT_TYPE[t],o.bind(e,this)):r.publish(r.EVENT_TYPE.WARN,'Warning: Invalid event type "'+t+'"'));return this},p.prototype.timeout=function(t){return this.pushApiCall_("api.timeout",arguments),"number"===o.asType(t)&&this.mediator.timeout(t),this.mediator.getTimeout()},p.prototype.doneCallbackOffset=function(t){return this.pushApiCall_("api.doneCallbackOffset",arguments),"number"===o.asType(t)&&this.mediator.doneCallbackOffset(t),this.mediator.getDoneCallbackOffset()},p.prototype.setAuctionTrigger=function(t){return this.pushApiCall_("api.setAuctionTrigger",arguments),this.mediator.setAuctionTrigger(t),this},p.prototype.addBidTransform=function(t){return this.pushApiCall_("api.addBidTransform",arguments),this.mediator.addBidTransform(t),this},p.prototype.addRequestTransform=function(t){return this.pushApiCall_("api.addRequestTransform",arguments),this.mediator.addRequestTransform(t),this},p.prototype.start=function(t,e){this.pushApiCall_("api.start",arguments);var i=u(this);return"function"==typeof e&&e(i.hasError,i.details),this.mediator.start(this.randomizeBidRequests_,t),this},p.prototype.refresh=function(t){return this.pushApiCall_("api.refresh",arguments),this.mediator.refresh(t),this},p.prototype.prefixDefaultBidKey=function(t){return this.mediator.prefixDefaultBidKey(t),this},p.prototype.omitDefaultBidKey=function(t){return this.mediator.omitDefaultBidKey(t),this},p.prototype.throwErrors=function(t){return this.mediator.throwErrors(t),this},p.prototype.library=i.library,e.pubfood=i,i})},{"./errors":5,"./event":6,"./interfaces":7,"./logger":8,"./mediator/auctionmediator":9,"./util":17}],16:[function(t,e,i){"use strict";function r(){this.id=o.newId(),this.params_={}}var o=t("./util");r.prototype.setParam=function(t,e){var i=o.asType(t);return"object"!==i&&"array"!==i&&"function"!==i&&"undefined"!==i&&(this.params_[t]=e),this},r.prototype.getParam=function(t){return this.params_[t]},r.prototype.getParamKeys=function(){var t=[];for(var e in this.params_)t.push(this.params_[e]);return t},e.exports=r},{"./util":17}],17:[function(t,e,i){"use strict";var r={asType:function(t){return{}.toString.call(t).match(/\s([a-zA-Z]+)/)[1].toLowerCase()},newId:function(){return(+new Date).toString(36)+"xxxxxxxxxx".replace(/[x]/g,function(){return(0|36*Math.random()).toString(36)})},extendsObject:function(t,e){for(var i in e.prototype)t.prototype[i]=e.prototype[i];t.prototype.parents=t.prototype.parents||[],
t.prototype.parents.push(function(){return e}),t.prototype.init_=function(t,e,i,r,o){for(var n=this.parents||[],s=arguments.length,a=0;a<n.length;a++)switch(s){case 0:n[a]().call(this);break;case 1:n[a]().call(this,t);break;case 2:n[a]().call(this,t,e);break;case 3:n[a]().call(this,t,e,i);break;case 4:n[a]().call(this,t,e,i,r);break;default:n[a]().call(this,t,e,i,r,o)}}},hasFunctions:function(t,e){if(!t)return!1;for(var i=!0,o=0;o<e.length;o++){var n=e[o];if(!t[n]||"function"===!r.asType(t[n])){i=!1;break}}return i},loadUri:function(t,e){var i=document,r=t||"";if(e)if("complete"===i.readyState||"loaded"===i.readyState);else try{i.write('<script src="'+r+'"></script>')}catch(o){}else{var n=document.createElement("script");n.async=!0,n.src=r,(i.head||i.body||i.documentElement).appendChild(n)}},bind:function(t,e){return function(){t.apply(e,Array.prototype.slice.call(arguments))}},mergeToObject:function(t,e){for(var i in e)e.hasOwnProperty(i)&&(this.isObject(e[i])?(t[i]||(t[i]={}),this.mergeToObject(t[i],e[i])):this.isArray(e[i])?(t[i]||(t[i]=[]),this.mergeToArray(t[i],e[i])):t[i]=e[i]);return t},mergeToArray:function(t,e){for(var i=0;i<e.length;i++)t.push(this.clone(e[i]));return t},isArray:function(t){return!!t&&"array"===this.asType(t)},isObject:function(t){return!!t&&"object"===this.asType(t)},clone:function(t){return this.isObject(t)?this.cloneObject(t):this.isArray(t)?this.cloneArray(t):t},cloneArray:function(t){return this.mergeToArray([],t)},cloneObject:function(t){return this.mergeToObject({},t)},values:function(t){var e=[];for(var i in t)e.push(t[i]);return e},validate:function(t,e){if(!e)return!1;var i=0;for(var o in t)if("optional"!==o){var n=!!t.optional&&!!t.optional[o],s=e.hasOwnProperty(o),a=this.asType(e[o]),u=!e.init,p=!0;if(("null"===a||"undefined"===a||"number"===a&&!isFinite(e[o])||"string"===a&&""===e[o])&&(p=!1),n||s&&p||++i,p&&u&&r.isArray(e[o])&&0===e[o].length&&++i,p&&!u&&r.asType(e[o])!==r.asType(t[o])&&++i,i>0)break}return!i}};r.randomize=function(t){for(var e,i,r=t.length;r;)i=Math.floor(Math.random()*r--),e=t[r],t[r]=t[i],t[i]=e;return t},e.exports=r},{}]},{},[15])(15)});